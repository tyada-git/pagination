name: LLM Test Suggester

# This workflow analyzes the git diff of a pull request and asks Claude (Anthropic)
# to suggest targeted tests to run. The suggestions are posted as a comment on the PR.
#
# Requirements:
# - Set repository secret `ANTHROPIC_API_KEY` with a valid Anthropic (Claude) API key.
# - This workflow uses `pull_request_target` to allow access to repo secrets.
#   WARNING: `pull_request_target` runs workflow code from the base branch,
#   but it checks out the PR HEAD for diff computation. Be mindful of
#   security implications when running with secrets (forked PRs may be restricted).
# - Claude models used: claude-3-5-sonnet (fast, good quality)

on:
  pull_request_target:
    types: [opened, synchronize, reopened, edited]

concurrency:
  group: llm-test-suggester-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  analyze-diff:
    name: Analyze PR diff and ask LLM
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR head and base
        run: |
          echo "Base ref: ${{ github.event.pull_request.base.ref }}"
          echo "Head sha: ${{ github.event.pull_request.head.sha }}"
          git fetch --no-tags --prune --depth=1 origin ${{ github.event.pull_request.base.ref }}
          git fetch --no-tags --prune --depth=1 origin ${{ github.event.pull_request.head.ref }}

      - name: Create full diff
        run: |
          BASE=origin/${{ github.event.pull_request.base.ref }}
          HEAD=${{ github.event.pull_request.head.sha }}
          git --no-pager diff --no-color $BASE...$HEAD > full_diff.patch || true
          git --no-pager diff --name-only $BASE...$HEAD > changed_files.txt || true
          echo "Diff size: $(wc -c < full_diff.patch) bytes"

      - name: Ask LLM for test suggestions
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python - <<'PY'
          import os, json, sys, urllib.request, urllib.error, time, random

          # Load diff
          try:
              diff = open('full_diff.patch', 'r', encoding='utf-8').read()
          except Exception:
              diff = ''

          changed_files = open('changed_files.txt','r',encoding='utf-8').read()

          if not os.getenv('ANTHROPIC_API_KEY'):
              print('ANTHROPIC_API_KEY not set; exiting')
              sys.exit(0)

          system_msg = (
              'You are an assistant that analyzes a git diff and returns a concise, actionable list of tests to run. '
              'For each relevant change, suggest: (1) what to test (unit/integration/e2e), (2) specific files or test names to run or add, and (3) why the test matters. '
              'Be brief and use bullet points. If the diff contains many unrelated files, group suggestions by area or file path.'
          )

          user_msg = 'Changed files:\n' + changed_files + '\n\nDiff:\n' + diff[:20000]

          payload = {
              'model': 'claude-3-5-sonnet-20241022',
              'max_tokens': 800,
              'system': system_msg,
              'messages': [
                  {'role': 'user', 'content': user_msg}
              ]
          }

          def call_claude_with_retries(payload, max_retries=5):
              delay = 1.0
              for attempt in range(1, max_retries+1):
                  try:
                      req = urllib.request.Request(
                          'https://api.anthropic.com/v1/messages',
                          data=json.dumps(payload).encode('utf-8'),
                          headers={
                              'Content-Type': 'application/json',
                              'x-api-key': os.environ['ANTHROPIC_API_KEY'],
                              'anthropic-version': '2023-06-01'
                          }
                      )
                      with urllib.request.urlopen(req, timeout=60) as resp:
                          return json.load(resp)
                  except urllib.error.HTTPError as e:
                      body = e.read().decode('utf-8', errors='replace')
                      retry_after = e.headers.get('Retry-After')
                      print(f'HTTPError status={e.code}, attempt={attempt}/{max_retries}, retry-after={retry_after}')
                      print(f'Error body: {body[:1000]}')
                      if e.code == 429:
                          if retry_after:
                              wait = float(retry_after)
                          else:
                              wait = delay + random.uniform(0, 1.0)
                          print(f'Rate limited. Waiting {wait:.1f}s before retry...')
                          time.sleep(wait)
                          delay *= 2
                          continue
                      else:
                          raise
                  except Exception as e:
                      print(f'Request failed (attempt {attempt}/{max_retries}):', e)
                      if attempt < max_retries:
                          time.sleep(delay + random.uniform(0, 1.0))
                          delay *= 2
                      else:
                          raise
              raise RuntimeError('Max retries exceeded for Claude API')

          result = call_claude_with_retries(payload)
          suggestion = result['content'][0]['text'].strip()

          # Prepare comment body
          header = '### ðŸ¤– Claude Test Suggestions\n\n'
          body = header + suggestion

          # Read event to get PR number
          evpath = os.environ.get('GITHUB_EVENT_PATH')
          pr_num = None
          if evpath and os.path.exists(evpath):
              ev = json.load(open(evpath))
              pr_num = ev.get('number') or ev.get('pull_request', {}).get('number')

          if not pr_num:
              print('PR number not found in event payload; skipping comment')
              print(body)
              sys.exit(0)

          comment = {'body': body}

          api_url = f'https://api.github.com/repos/{os.environ["GITHUB_REPOSITORY"]}/issues/{pr_num}/comments'
          req2 = urllib.request.Request(api_url, data=json.dumps(comment).encode('utf-8'),
                                        headers={'Authorization': 'token ' + os.environ['GITHUB_TOKEN'], 'Content-Type': 'application/json'})
          try:
              with urllib.request.urlopen(req2) as resp2:
                  print('Posted comment, status', resp2.status)
          except Exception as e:
              print('Failed to post comment:', e)
          PY

      - name: Output summary
        run: |
          echo "Changed files:"
          cat changed_files.txt || true
