name: LLM Test Suggester (GitHub AI Native)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # we will refetch full SHAs later

      - name: Compute Diff Safely (using SHAs)
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          # Fetch the exact SHAs to guarantee merge-base exists
          git fetch origin +$BASE_SHA:$BASE_SHA
          git fetch origin +$HEAD_SHA:$HEAD_SHA

          # Generate diff and file list
          git --no-pager diff --no-color $BASE_SHA...$HEAD_SHA > full_diff.patch || true
          git --no-pager diff --name-only $BASE_SHA...$HEAD_SHA > changed_files.txt || true

          echo "Diff size: $(wc -c < full_diff.patch) bytes"

      - name: Prepare AI Prompt
        run: |
          echo "Analyze the following git diff and produce:" > prompt.txt
          echo "- Required Unit/Integration/E2E tests" >> prompt.txt
          echo "- Exact test file names or new tests to add" >> prompt.txt
          echo "- Why each test matters" >> prompt.txt
          echo "" >> prompt.txt

          echo "Changed files:" >> prompt.txt
          cat changed_files.txt >> prompt.txt
          echo "" >> prompt.txt

          echo "Diff content (truncated to 20k chars):" >> prompt.txt
          head -c 20000 full_diff.patch >> prompt.txt

      - name: Invoke GitHub AI
        id: ai
        uses: actions/ai-inference@v1
        with:
          prompt-file: prompt.txt
          max-tokens: 800

      - name: Post PR Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY="### ðŸ¤– GitHub AI Test Suggestions\n\n${{ steps.ai.outputs.response }}"
          gh pr comment ${{ github.event.pull_request.number }} --body "$BODY"
