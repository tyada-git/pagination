name: LLM Test Suggester (GitHub AI Native)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history required for SHAs

      - name: Compute Diff Safely (SHA â†’ SHA)
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          # Fetch both SHAs explicitly
          git fetch origin +$BASE_SHA:$BASE_SHA || true
          git fetch origin +$HEAD_SHA:$HEAD_SHA || true

          # Generate diff and file list (fallback to empty diff)
          git --no-pager diff --no-color $BASE_SHA...$HEAD_SHA > full_diff.patch || echo "" > full_diff.patch
          git --no-pager diff --name-only $BASE_SHA...$HEAD_SHA > changed_files.txt || echo "" > changed_files.txt

          echo "Diff bytes: $(wc -c < full_diff.patch)"

      - name: Prepare AI Prompt
        run: |
          {
            echo "You are a senior QA automation engineer."
            echo "Analyze the git diff and produce:"
            echo "- Required Unit / Integration / E2E tests"
            echo "- Exact file names for new or updated tests"
            echo "- Why each test is important"
            echo "- Edge cases and regression risks"
            echo ""
            echo "Changed files:"
            cat changed_files.txt
            echo ""
            echo "Diff content (first 20k chars):"
            head -c 20000 full_diff.patch
          } > prompt.txt

      - name: Invoke GitHub AI
        id: ai
        uses: actions/ai-inference@v1
        with:
          model: 'gpt-4o-mini'   # explicit model recommended
          prompt-file: prompt.txt
          max-tokens: 800

      - name: Post PR Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # GitHub CLI cannot handle raw multi-line env var directly,
          # so we write the response into a file.
          echo "### ðŸ¤– GitHub AI Test Suggestions" > comment.md
          echo "" >> comment.md
          echo "${{ steps.ai.outputs.response }}" >> comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
